import{__awaiter as e,__generator as t,__assign as n}from"../../../node_modules/tslib/tslib.es6.js";import{mapKeys as r,keyBy as a}from"lodash";var i={htmlString:void 0,html:void 0,values:[],map:{},mapValues:function(){return i.map=r(a(i.values,"title"),(function(e,t){return t.slice(2)})),i.map}},l=function(e){return(new DOMParser).parseFromString(e,"text/html")},s=function(n,r){return void 0===r&&(r=!1),e(void 0,void 0,void 0,(function(){var e;return t(this,(function(t){return i.values.length>0&&!r||(e=Array.from(n.getElementsByClassName("sppb-addon-article")),i.values=e.map((function(e){return{title:e.getElementsByTagName("h3")[0]?e.getElementsByTagName("h3")[0].innerText:"",content:e.getElementsByClassName("sppb-article-introtext")[0]?e.getElementsByClassName("sppb-article-introtext")[0].innerText:"",imgSrc:e.getElementsByTagName("img")[0]?e.getElementsByTagName("img")[0].src:"",link:e.firstChild.href}})),i.mapValues()),[2,i.values]}))}))},c=function(e){var t=e.getElementsByTagName("article")[0];if(!t)throw new Error("cant find article");var n=t.getElementsByClassName("tags")[0],r=t.getElementsByClassName("sppb-addon-content")[0],a=t.getElementsByClassName("entry-image")[0].getElementsByTagName("img")[0],i=r.children[r.childElementCount-2],l=r.children[r.childElementCount-1];return{subtitle:n?n.innerText:"",ref:l?l.innerText:"",content:i?i.innerText:"",fallbackImgSrc:a.src}};window._proxyCache=i;var o=function(){function r(e){this.proxyFetcher=e.proxyFetcher,this.cmsPath=e.cmsPath}return Object.defineProperty(r.prototype,"url",{get:function(){return"https://dguidedwalks.tw/"+encodeURI(this.cmsPath)},enumerable:!1,configurable:!0}),r.prototype.getDetailByTitle=function(r,a){return e(this,void 0,void 0,(function(){var e,s,o,m,u;return t(this,(function(t){switch(t.label){case 0:return i.values.length<1?[4,this.getAll()]:[3,2];case 1:t.sent(),t.label=2;case 2:return(e=i.map[r]||i.map[r.slice(2)])?[3,5]:a?(console.warn("title: ".concat(r," not found, fallback url: ").concat(a)),[4,this.proxyFetcher(a)]):[3,4];case 3:return o=t.sent(),m=l(o),s=c(m),[2,n(n({},s),{title:r,imgSrc:s.fallbackImgSrc,link:a})];case 4:throw new Error("cant find title: ".concat(r));case 5:return function(e){return e.subtitle&&e.ref&&e.content}(e)?[2,e]:[3,6];case 6:return[4,this.proxyFetcher(e.link)];case 7:return o=t.sent(),m=l(o),u=c(m),i.map[r]=n(n({},e),u),[2,i.map[r]]}}))}))},r.prototype.getAll=function(n){return void 0===n&&(n=!1),e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return!i.html||n?[3,1]:(e=i.html,[3,3]);case 1:return r=i,[4,this.proxyFetcher(this.url)];case 2:r.htmlString=t.sent(),i.html=l(i.htmlString),e=i.html,t.label=3;case 3:return[4,s(e)];case 4:return[2,t.sent()]}}))}))},r}();export{o as default};
//# sourceMappingURL=index.js.map
