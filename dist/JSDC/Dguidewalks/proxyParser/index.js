import{__awaiter as t,__generator as e,__assign as n}from"../../../node_modules/tslib/tslib.es6.js";import{mapKeys as r,keyBy as i}from"lodash";var a={htmlString:void 0,html:void 0,values:[],map:{},mapValues:function(){return a.map=r(i(a.values,"title"),(function(t,e){return e.slice(2)})),a.map}},s=function(t){return(new DOMParser).parseFromString(t,"text/html")},l=function(n,r){return void 0===r&&(r=!1),t(void 0,void 0,void 0,(function(){var t;return e(this,(function(e){return a.values.length>0&&!r||(t=Array.from(n.getElementsByClassName("sppb-addon-article")),a.values=t.map((function(t){return{title:t.getElementsByTagName("h3")[0]?t.getElementsByTagName("h3")[0].innerText:"",content:t.getElementsByClassName("sppb-article-introtext")[0]?t.getElementsByClassName("sppb-article-introtext")[0].innerText:"",imgSrc:t.getElementsByTagName("img")[0]?t.getElementsByTagName("img")[0].src:"",link:t.firstChild.href}})),a.mapValues()),[2,a.values]}))}))},o=function(){function r(t){this.proxyFetcher=t.proxyFetcher,this.cmsPath=t.cmsPath}return Object.defineProperty(r.prototype,"url",{get:function(){return"https://dguidedwalks.tw/"+encodeURI(this.cmsPath)},enumerable:!1,configurable:!0}),r.prototype.getDetailByTitle=function(r){return t(this,void 0,void 0,(function(){var t,i,l,o;return e(this,(function(e){switch(e.label){case 0:return a.values.length<1?[4,this.getAll()]:[3,2];case 1:e.sent(),e.label=2;case 2:if(!(t=a.map[r]))throw new Error("cant find title: ".concat(r));return function(t){return t.subtitle&&t.ref&&t.content}(t)?[2,t]:[3,3];case 3:return[4,this.proxyFetcher(t.link)];case 4:return i=e.sent(),l=s(i),o=function(t){var e=t.getElementsByTagName("article")[0];if(!e)throw new Error("cant find article");var n=e.getElementsByClassName("tags")[0],r=e.getElementsByClassName("badge")[0],i=e.getElementsByClassName("sppb-addon-content")[0].firstChild;return{subtitle:n?n.innerText:"",ref:r?r.innerText:"",content:i?i.innerText:""}}(l),a.map[r]=n(n({},t),o),[2,a.map[r]]}}))}))},r.prototype.getAll=function(n){return void 0===n&&(n=!1),t(this,void 0,void 0,(function(){var t,r;return e(this,(function(e){switch(e.label){case 0:return!a.html||n?[3,1]:(t=a.html,[3,3]);case 1:return r=a,[4,this.proxyFetcher(this.url)];case 2:r.htmlString=e.sent(),a.html=s(a.htmlString),t=a.html,e.label=3;case 3:return[4,l(t)];case 4:return[2,e.sent()]}}))}))},r}();export{o as default};
//# sourceMappingURL=index.js.map
